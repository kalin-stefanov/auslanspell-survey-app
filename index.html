<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Auslan Fingerspelling Survey</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      min-height: 100vh;
      font-family: sans-serif;
      background-color: #fff;
      color: #111;
      margin: 0;
      padding: 0;
    }
    header {
      text-align: center;
      margin-bottom: 20px;
      color: #111;
    }
    .video-frame {
      width: 80%;
      max-width: 800px;
      margin: 0 auto;
      padding: 16px;
      background-color: #fff;
      display: flex;
      justify-content: center;
    }
    .video-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
    }
    .question-container {
      text-align: center;
      margin-top: 30px;
    }
    .question {
      font-size: 18px;
      margin-bottom: 16px;
      color: #111;
    }
    .option {
      display: block;
      margin: 8px auto;
      padding: 10px 20px;
      width: 250px;
      background-color: #fff;
      border: 2px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      color: #111;
      transition: background-color 0.2s, color 0.2s, border-color 0.2s;
    }
    .option:hover {
      background-color: #f5f5f5;
      border-color: #111;
    }
    .option.selected {
      background-color: #111;
      color: #fff;
      border-color: #111;
    }
    #text-answer {
      padding: 10px;
      width: 300px;
      font-size: 16px;
      border-radius: 8px;
      border: 1px solid #ccc;
      background: #fff;
      color: #111;
    }
    #next-button {
      display: block;
      margin: 30px auto 10px;
      padding: 12px 44px;
      background-color: #111;
      color: #fff;
      border: 1px solid #111;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #next-button:hover {
      background: #fff;
      color: #111;
      border: 1px solid #111;
    }
    #start-survey-button {
      display: block;
      margin: 30px auto 10px;
      padding: 12px 44px;
      background-color: #111;
      color: #fff;
      border: 1px solid #111;
      border-radius: 5px;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    #start-survey-button:hover {
      background: #fff;
      color: #111;
      border: 1px solid #111;
    }
    .progress-bar-container {
      width: 80%;
      max-width: 800px;
      margin: 20px auto;
      background-color: #eee;
      border-radius: 10px;
      overflow: hidden;
    }
    .progress-bar {
      height: 12px;
      width: 0%;
      background-color: #111;
      transition: width 0.3s ease-in-out;
    }
    #completion-message {
      text-align: center;
      margin-top: 50px;
      font-size: 20px;
      color: #111;
    }
    #user-info-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 60vh;
      margin-bottom: 30px;
    }
  </style>
</head>
<body>
  <div id="user-info-container">
    <input type="text" id="user-name" placeholder="Name" style="margin:8px; padding:10px; width:220px; border-radius:5px; border:1px solid #ccc;">
    <input type="email" id="user-email" placeholder="Email" style="margin:8px; padding:10px; width:220px; border-radius:5px; border:1px solid #ccc;">
    <button id="start-survey-button">Start</button>
  </div>

  <header style="display:none;">
    <h2>Auslan Fingerspelling Survey</h2>
    <p>Please watch the video and answer the question below.</p>
  </header>

  <div class="video-frame" style="display:none;">
    <div class="video-container">
      <iframe
        id="vimeo-player"
        width="560"
        height="315"
        src=""
        frameborder="0"
        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
        allowfullscreen>
      </iframe>
      <div id="video-overlay" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); color:#111; font-size:1.3em; display:flex; align-items:center; justify-content:center; z-index:2;">
        You have reached the maximum of 3 plays for this video.
      </div>
    </div>
  </div>

  <div class="question-container" id="question-container" style="display:none;">
    <div class="question" id="question-text"></div>
    <div id="options-container"></div>
    <input type="text" id="text-answer" style="display: none;" placeholder="Type your answer here..." />
    <button id="next-button">Next</button>
  </div>

  <div class="progress-bar-container" style="display:none;">
    <div class="progress-bar" id="progress-bar"></div>
  </div>

  <div id="completion-message" style="display: none;">
    ðŸŽ‰ Thank you for completing the survey! Your responses have been saved.
  </div>

  <script>
    const totalRounds = 30;
    let currentRound = 0;
    const responses = [];

    const videoPlayCounts = Array(totalRounds).fill(0);

    const videoIds = Array.from({ length: totalRounds }, (_, i) =>
      ['760137731?h=789f74dbe5', '760137751?h=a402a746e6', '760137777?h=92fa26172b', '760137799?h=bdc1e4d649', '760137826?h=320b161496', '760137852?h=94badb1ee9', '760137885?h=d9c41737af', '760137908?h=0b79edb458', '760137937?h=7ee1a2285a', '760137950?h=3e347c6d20', '760137971?h=1d62e999f3', '760137998?h=2a00863b5b', '760138008?h=8ef1a2cad5', '760138027?h=0125bae0c4', '760138047?h=8f7f6ebb4d', '760138071?h=3bb457491f', '760138092?h=169c2376de', '760138109?h=7a5a94ca93', '760138132?h=c9db8310f1', '760138157?h=c95b94b0e2', '760141416?h=7b50a9f2cb', '760141440?h=e214495261', '760141462?h=08c6ff5297', '760141489?h=cc26610476', '760138188?h=284a72c899', '760138209?h=c70415231f', '760138231?h=bd989d248c', '760138254?h=6073e71a3f', '760137715?h=59d02ad1ac', '760123345?h=10d7cee8e5'][i % 3]
    );

    const questions = Array.from({ length: totalRounds }, () => {
      return Math.random() > 0.5
        ? {
            type: 'multiple',
            text: 'What is the sign in the video?',
            options: ['apples', 'contend', 'frosty', 'geometry', 'gravy']
          }
        : {
            type: 'text',
            text: 'What is the sign in the video?'
          };
    });

    function loadRound(index) {
      const videoId = videoIds[index];
      const question = questions[index];

      document.getElementById('vimeo-player').src =
        'https://player.vimeo.com/video/' + videoId + '&controls=1&title=0&byline=0&portrait=0';

      const questionText = document.getElementById('question-text');
      const optionsContainer = document.getElementById('options-container');
      const textInput = document.getElementById('text-answer');

      questionText.textContent = question.text;
      optionsContainer.innerHTML = '';
      textInput.style.display = 'none';
      textInput.value = '';

      if (question.type === 'multiple') {
        question.options.forEach(opt => {
          const btn = document.createElement('div');
          btn.className = 'option';
          btn.textContent = opt;
          btn.addEventListener('click', () => {
            document.querySelectorAll('.option').forEach(o => o.classList.remove('selected'));
            btn.classList.add('selected');
          });
          optionsContainer.appendChild(btn);
        });
      } else {
        textInput.style.display = 'inline-block';
      }

      // Add play limit logic
      const iframe = document.getElementById('vimeo-player');
      const overlay = document.getElementById('video-overlay');
      // Remove any previous event listener by replacing the iframe
      const newIframe = iframe.cloneNode(true);
      iframe.parentNode.replaceChild(newIframe, iframe);

      // Listen for play events using the Vimeo Player API
      const player = new window.Vimeo.Player(newIframe);

      player.on('play', function() {
        videoPlayCounts[index]++;
        if (videoPlayCounts[index] > 3) {
          player.pause();
          overlay.style.display = 'flex';
          newIframe.style.pointerEvents = 'none';
        }
      });

      // Reset overlay and pointer events for new round
      overlay.style.display = 'none';
      newIframe.style.pointerEvents = 'auto';
      updateProgress();
    }

    // Add Vimeo Player API script if not already present
    if (!document.getElementById('vimeo-api')) {
      const tag = document.createElement('script');
      tag.src = "https://player.vimeo.com/api/player.js";
      tag.id = "vimeo-api";
      document.body.appendChild(tag);
    }

    document.getElementById('next-button').addEventListener('click', () => {
      const question = questions[currentRound];
      let answer = '';

      if (question.type === 'multiple') {
        const selected = document.querySelector('.option.selected');
        if (!selected) return alert('Please select an answer.');
        answer = selected.textContent;
      } else {
        answer = document.getElementById('text-answer').value.trim();
        if (!answer) return alert('Please enter a response.');
      }

      const response = {
        name: userName,
        email: userEmail,
        round: currentRound + 1,
        videoId: videoIds[currentRound],
        questionType: question.type,
        answer: answer
      };
      responses.push(response);
      submitToGoogleSheets(response);

      currentRound++;

      if (currentRound >= totalRounds) {
        document.querySelector('header').style.display = 'none';
        document.querySelector('.video-frame').style.display = 'none';
        document.getElementById('question-container').style.display = 'none';
        document.querySelector('.progress-bar-container').style.display = 'none';
        document.getElementById('completion-message').style.display = 'block';
      } else {
        loadRound(currentRound);
      }
    });

    function updateProgress() {
      const percent = ((currentRound) / totalRounds) * 100;
      document.getElementById('progress-bar').style.width = percent + '%';
    }

    function submitToGoogleSheets(response) {
      fetch('YOUR_GOOGLE_SCRIPT_URL', {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(response)
      });
    }

    let userName = '';
    let userEmail = '';

    document.getElementById('start-survey-button').addEventListener('click', () => {
      const name = document.getElementById('user-name').value.trim();
      const email = document.getElementById('user-email').value.trim();
      if (!name) return alert('Please enter your name.');
      if (!email || !/^[^@]+@[^@]+\.[^@]+$/.test(email)) return alert('Please enter a valid email address.');
      userName = name;
      userEmail = email;
      document.getElementById('user-info-container').style.display = 'none';
      document.querySelector('header').style.display = '';
      document.querySelector('.video-frame').style.display = '';
      document.getElementById('question-container').style.display = '';
      document.querySelector('.progress-bar-container').style.display = '';
      loadRound(currentRound);
    });

  </script>
</body>
</html>
